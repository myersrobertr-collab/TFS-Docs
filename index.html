<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TFS Documents</title>
  <link rel="manifest" href="app.webmanifest?v=2025.9.1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0f19" />

  <!-- üîß One-stop version bump -->
  <script>
    window.APP_VERSION  = "2025.9.1";
    window.MANIFEST_URL = `docs/manifest.json?v=${APP_VERSION}`;
    window.CACHE_NAME   = `tfs-docs-${APP_VERSION}`;
  </script>

  <style>
    :root {
      --bg:#0b0f19; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --accent:#2563eb; --accent2:#e4002b; --btn:#1f2937; --btnText:#f9fafb;
      --ring:#334155; --chip:#0f172a; --chipOn:#172554;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px 40px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:22px;margin:8px 0}
    .tag{font-size:12px;color:#cbd5e1}
    .bar{margin:12px 0 20px;border-top:1px solid #1f2937}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls input[type="search"]{
      background:#0f172a;color:var(--text);border:1px solid #243041;border-radius:12px;
      padding:10px 12px;min-width:210px;outline:none
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      background:var(--chip); color:#cbd5e1; border:1px solid #233144; border-radius:999px;
      padding:.35rem .7rem; font-size:.85rem; cursor:pointer; user-select:none
    }
    .chip.active{ background:var(--chipOn); color:#93c5fd; border-color:#1e3a8a }
    .btn{
      display:inline-block; background:var(--btn); color:var(--btnText); border:1px solid #273244;
      border-radius:12px; padding:.65rem .9rem; font-weight:700; text-decoration:none
    }
    .btn:hover{ filter:brightness(1.06) }
    .btn.primary{ background:var(--accent2); border-color:var(--accent2) }
    .btn.ghost{ background:transparent; color:#cbd5e1 }
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .section{margin:18px 0}
    .section h2{font-size:16px;margin:0 0 10px;color:#cbd5e1}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .muted{color:var(--muted);font-size:13px;min-height:32px;margin-bottom:10px}

    .banner{
      display:none; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      background:#0f172a; border:1px solid #243041; border-radius:12px; padding:10px 12px; margin-bottom:12px
    }
    .banner.show{ display:flex }
    .banner strong{ color:#e5e7eb; font-weight:700 }
    .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .small{ font-size:12px; color:#9ca3af }
    .footer-note{ margin-top:24px; color:#94a3b8; font-size:12px; text-align:center }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Update available banner -->
    <div id="updateBanner" class="banner">
      <div><strong>Update available.</strong> A newer version of TFS Docs is ready.</div>
      <div class="right">
        <button id="updateNow" class="btn primary">Update now</button>
        <button id="dismissUpdate" class="btn ghost">Later</button>
      </div>
    </div>

    <!-- Install (Add to Home Screen) banner -->
    <div id="installBanner" class="banner">
      <div><strong>Install TFS Docs</strong> for faster access and offline use.</div>
      <div class="right">
        <button id="installBtn" class="btn">Install app</button>
        <button id="dismissInstall" class="btn ghost">Dismiss</button>
      </div>
    </div>

    <header>
      <div>
        <h1>üóÇÔ∏è TFS Documents</h1>
        <div class="tag">
          App v<span id="appVer">‚Äî</span>
          <span class="small">¬∑ Library v<span id="libVer">‚Äî</span></span>
        </div>
        <div id="chipRow" class="chips" aria-label="Filters"></div>
      </div>
      <div class="controls">
        <input id="q" type="search" placeholder="Search‚Ä¶" />
        <button id="offlineBtn" class="btn" title="Prefetch all PDFs for offline use">Download for offline</button>
      </div>
    </header>

    <div class="bar"></div>

    <!-- sections render here -->
    <div id="sections"></div>

    <div class="footer-note">If a PDF won‚Äôt open offline at first try, tap the
      <em>Download for offline</em> button once after updates.</div>
  </div>

  <script>
    // ---------- tiny helpers ----------
    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    // ---------- global state ----------
    const APP_VERSION = window.APP_VERSION;
    const MANIFEST_URL = window.MANIFEST_URL;
    const CACHE_NAME = window.CACHE_NAME;

    let DOCS = [];            // sections[]
    let TAG_META = [];        // list of tags
    let LIB_VERSION = "";     // manifest.version
    const selectedTags = new Set();  // active tag filters
    let deferredPrompt = null;       // for A2HS

    // ---------- UI: tag chips ----------
    function renderTagChips(tags) {
      const host = $('#chipRow');
      host.innerHTML = '';
      if (!tags || !tags.length) return;
      tags.forEach(tag => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'chip';
        chip.textContent = tag;
        chip.onclick = () => {
          if (selectedTags.has(tag)) selectedTags.delete(tag);
          else selectedTags.add(tag);
          chip.classList.toggle('active');
          renderSections(DOCS);
        };
        host.appendChild(chip);
      });
    }

    // ---------- UI: sections/cards ----------
    function renderSections(sections) {
      const q = ($('#q')?.value || '').trim().toLowerCase();
      const activeTags = Array.from(selectedTags);
      const host = $('#sections');
      host.innerHTML = '';

      sections.forEach(sec => {
        // filter by tags (section-level)
        const passTag = !activeTags.length || (sec.tags || []).some(t => selectedTags.has(t));
        if (!passTag) return;

        // filter items by search
        const items = (sec.items || []).filter(it =>
          !q || it.label.toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q)
        );
        if (!items.length) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'section';
        wrapper.innerHTML = `<h2>${sec.title || ''}</h2>`;
        const grid = document.createElement('div'); grid.className = 'grid';

        items.forEach(it => {
          const href = `${it.href}${it.href.includes('?') ? '&' : '?'}v=${APP_VERSION}`;
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="muted">${it.desc ? it.desc : '&nbsp;'}</div>
            <a class="btn" href="${href}" target="_blank" rel="noopener">${it.label}</a>
          `;
          grid.appendChild(card);
        });

        wrapper.appendChild(grid);
        host.appendChild(wrapper);
      });
    }

    // ---------- offline prefetch ----------
    async function prefetchForOffline(sections) {
      const urls = new Set([
        './',
        `sw.js?v=${APP_VERSION}`,
        `app.webmanifest?v=${APP_VERSION}`,
        // PDFs(+version)
        ...sections.flatMap(s => (s.items||[]).map(i =>
          `${i.href}${i.href.includes('?') ? '&' : '?'}v=${APP_VERSION}`
        )),
      ]);
      try {
        const cache = await caches.open(CACHE_NAME);
        await cache.addAll(Array.from(urls));
        alert('Documents cached for offline use üëç');
      } catch (e) {
        console.error(e);
        alert('Could not cache all documents. Try again after files finish uploading.');
      }
    }

    // ---------- service worker + update handling ----------
    async function setupServiceWorker() {
      if (!('serviceWorker' in navigator)) return;

      const reg = await navigator.serviceWorker.register(`sw.js?v=${APP_VERSION}`, { updateViaCache: 'none' });

      // show update banner when a new SW is found
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        if (!newSW) return;
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            $('#updateBanner')?.classList.add('show');
          }
        });
      });

      // handle "Update now"
      $('#updateNow')?.addEventListener('click', async () => {
        const regs = await navigator.serviceWorker.getRegistrations();
        regs.forEach(r => r.active?.postMessage({ type: 'SKIP_WAITING' }));
      });

      // close banner
      $('#dismissUpdate')?.addEventListener('click', () => {
        $('#updateBanner')?.classList.remove('show');
      });

      // reload when the new SW takes control
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }

    // ---------- install (A2HS) banner ----------
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('#installBanner')?.classList.add('show');
    });
    $('#installBtn')?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      $('#installBanner')?.classList.remove('show');
    });
    $('#dismissInstall')?.addEventListener('click', () => {
      $('#installBanner')?.classList.remove('show');
      deferredPrompt = null;
    });

    // ---------- manifest load + boot ----------
    async function loadDocs() {
      try {
        const r = await fetch(MANIFEST_URL, { cache: 'no-cache' });
        if (!r.ok) throw new Error('manifest missing');
        const m = await r.json();
        DOCS = m.sections || [];
        TAG_META = m.tagMeta || [];
        LIB_VERSION = m.version || '';
      } catch {
        DOCS = [{ title: 'MISC', tags: ['Misc'], items: [] }];
        TAG_META = ['Misc'];
        LIB_VERSION = '';
      }
      $('#appVer').textContent = APP_VERSION;
      $('#libVer').textContent = LIB_VERSION || '‚Äî';
      renderTagChips(TAG_META);
      renderSections(DOCS);
    }

    // ---------- event wiring ----------
    $('#q')?.addEventListener('input', () => renderSections(DOCS));
    $('#offlineBtn')?.addEventListener('click', () => prefetchForOffline(DOCS));

    // ---------- start ----------
    (async function start(){
      await setupServiceWorker();
      await loadDocs();
    })();
  </script>
</body>
</html>

