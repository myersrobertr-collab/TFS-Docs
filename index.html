<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TFS Documents</title>
  <link rel="manifest" href="app.webmanifest" />

  <!-- üîß One-stop version bump -->
  <script>
    const APP_VERSION  = "2025.9.1";              // <‚Äî bump this ONLY
    const MANIFEST_URL = `docs/manifest.json?v=${APP_VERSION}`;
    const CACHE_NAME   = `tfs-docs-${APP_VERSION}`;
  </script>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0f19" />

  <style>
    :root { --bg:#0b0f19; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#2563eb; --accent2:#e4002b;
            --btn:#1f2937; --btnText:#f9fafb; --ring:#334155; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px 40px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:22px;margin:8px 0}
    .tag{font-size:12px;color:#cbd5e1}
    .bar{margin:12px 0 20px;border-top:1px solid #1f2937}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls input[type="search"]{
      background:#0f172a;color:var(--text);border:1px solid #243041;border-radius:12px;padding:10px 12px;
      min-width:200px;outline:none
    }
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .section{margin:18px 0}
    .section h2{font-size:16px;margin:0 0 10px;color:#cbd5e1}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .btn{
      display:block;width:100%;text-align:center;background:var(--btn);color:var(--btnText);
      border:1px solid #273244;border-radius:12px;padding:12px 14px;font-weight:700;text-decoration:none
    }
    .btn:hover{filter:brightness(1.06)}
    .primary{background:var(--accent2);border-color:var(--accent2)}
    .muted{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .pill{font-size:12px;color:#cbd5e1}
    /* install/update banners */
    .banner{position:sticky;top:0;z-index:5;background:#0f172a;border-bottom:1px solid #243041;padding:10px}
    .banner .inner{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .hidden{display:none}
    .linkish{background:#111827;color:#fff;border:1px solid #2b3648;border-radius:10px;padding:.5rem .8rem;font-weight:700;text-decoration:none}
    .linkish.primary{background:#E4002B;border-color:#E4002B}
    select{
      background:#0f172a;color:var(--text);border:1px solid #243041;border-radius:12px;padding:10px 12px;
      outline:none
    }
  </style>
</head>
<body>
  <!-- Install banner -->
  <div id="installBanner" class="banner hidden">
    <div class="inner">
      <div>üì≤ Install <strong>TFS Documents</strong> to your Home Screen for offline use.</div>
      <div class="toolbar">
        <button id="installBtn" class="linkish primary">Install</button>
        <button id="dismissInstall" class="linkish">Not now</button>
      </div>
    </div>
  </div>

  <!-- Update banner -->
  <div id="updateBanner" class="banner hidden">
    <div class="inner">
      <div>üîÑ A new version of the document hub is available.</div>
      <div class="toolbar">
        <button id="reloadBtn" class="linkish primary">Update now</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div>
        <h1>üóÇÔ∏è TFS Documents</h1>
        <div class="tag">Works offline ¬∑ Add/remove PDFs via <code>docs/manifest.json</code></div>
      </div>
      <div class="controls">
        <input id="q" type="search" placeholder="Search‚Ä¶" />
        <select id="tagFilter" multiple size="1" title="Filter by tags">
          <!-- options populated from manifest tagMeta -->
        </select>
        <button id="offlineBtn" class="linkish">Download for offline</button>
      </div>
    </header>

    <div class="bar"></div>

    <!-- where sections render -->
    <div id="sections"></div>
  </div>

  <script>
    // --- tiny helpers ---
    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    // --- state ---
    let DOCS = [];        // sections
    let TAGS = [];        // tagMeta (optional)
    let DEFERRED_INSTALL = null;
    let SW_REG = null;

    // --- UI render ---
    function renderSections(sections) {
      const q = ($('#q')?.value || '').trim().toLowerCase();
      const selectedTags = Array.from($('#tagFilter')?.selectedOptions || []).map(o => o.value);
      const host = $('#sections');
      host.innerHTML = '';

      sections.forEach(sec => {
        const items = (sec.items || []).filter(it => {
          const passesQ = !q || it.label.toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q);
          const itemTags = it.tags || sec.tags || [];
          const passesTag = selectedTags.length === 0 || selectedTags.some(t => itemTags.includes(t));
          return passesQ && passesTag;
        });
        if (!items.length) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'section';
        const title = sec.title || (sec.tags ? sec.tags.join(', ') : 'Section');
        wrapper.innerHTML = `<h2>${title}</h2>`;

        const grid = document.createElement('div');
        grid.className = 'grid';

        items.forEach(it => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="min-height:32px;margin-bottom:10px" class="muted">${it.desc || '&nbsp;'}</div>
            <a class="btn" href="${it.href}" target="_blank" rel="noopener">${it.label}</a>
          `;
          grid.appendChild(card);
        });

        wrapper.appendChild(grid);
        host.appendChild(wrapper);
      });
    }

    function renderTagFilter(tagMeta=[]) {
      const sel = $('#tagFilter');
      sel.innerHTML = '';
      // Add a "‚Äî filter tags ‚Äî" placeholder as a single option if no multi-select interaction
      if (!tagMeta.length) {
        sel.size = 1;
        sel.innerHTML = `<option value="">(no tags)</option>`;
        return;
      }
      tagMeta.forEach(tag => {
        const opt = document.createElement('option');
        opt.value = tag;
        opt.textContent = tag;
        sel.appendChild(opt);
      });
    }

    // --- offline prefetch ---
    async function prefetchForOffline(sections) {
      const urls = new Set([
        './', 'index.html', `sw.js?v=${APP_VERSION}`, `app.webmanifest`,
        // add all PDF hrefs:
        ...sections.flatMap(s => (s.items || []).map(i => i.href))
      ]);
      try {
        const cache = await caches.open(CACHE_NAME);
        await cache.addAll(Array.from(urls));
        alert('Documents cached for offline use üëç');
      } catch (e) {
        console.error(e);
        alert('Could not cache all documents (some may still be pending upload). Try again later.');
      }
    }

    // --- install banner ---
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      DEFERRED_INSTALL = e;
      $('#installBanner')?.classList.remove('hidden');
    });
    $('#installBtn')?.addEventListener('click', async () => {
      if (!DEFERRED_INSTALL) return;
      DEFERRED_INSTALL.prompt();
      await DEFERRED_INSTALL.userChoice;
      DEFERRED_INSTALL = null;
      $('#installBanner')?.classList.add('hidden');
    });
    $('#dismissInstall')?.addEventListener('click', () => {
      $('#installBanner')?.classList.add('hidden');
    });

    // --- SW register with versioned URL + update banner ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(`sw.js?v=${APP_VERSION}`).then(reg => {
        SW_REG = reg;
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              // new version ready
              $('#updateBanner')?.classList.remove('hidden');
            }
          });
        });
      }).catch(console.error);

      // when we tell SW to skip waiting it will switch controller -> reload
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        location.reload();
      });
    }
    $('#reloadBtn')?.addEventListener('click', () => {
      const w = SW_REG?.waiting;
      if (w) w.postMessage({ type: 'SKIP_WAITING' });
      else location.reload();
    });

    // --- search + filter handlers ---
    $('#q')?.addEventListener('input', () => renderSections(DOCS));
    $('#tagFilter')?.addEventListener('change', () => renderSections(DOCS));
    $('#offlineBtn')?.addEventListener('click', () => prefetchForOffline(DOCS));

    // --- load manifest + draw ---
    async function loadDocs() {
      try {
        const r = await fetch(MANIFEST_URL, { cache: 'no-cache' });
        if (!r.ok) throw new Error('manifest missing');
        const m = await r.json();
        DOCS = m.sections || [];
        TAGS = m.tagMeta || [];
        renderTagFilter(TAGS);
      } catch {
        DOCS = [{ title: 'MISC', items: [] }];
      }
      renderSections(DOCS);
    }
    loadDocs();
  </script>
</body>
</html>
