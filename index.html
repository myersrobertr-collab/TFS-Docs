<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TFS Documents</title>
  <link rel="manifest" href="app.webmanifest" />

  <!-- ONE place to bump version for cache-busting -->
  <script>
    window.APP_VERSION  = "2025.9.6";
    window.MANIFEST_URL = "docs/manifest.json";
    window.CACHE_NAME   = "tfs-docs-" + window.APP_VERSION;
  </script>

  <!-- iOS / theme niceties -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0f19" />

  <style>
    :root{
      --bg:#0b0f19; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --accent:#2563eb; --accent2:#e4002b; --chip:#1f2937; --chipActive:#0f172a;
      --ring:#334155; --btn:#1f2937; --btnText:#f9fafb; --line:#1f2937;
      --good:#22c55e; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    a{color:inherit}

    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px 44px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:22px;margin:6px 0 2px}
    .subline{font-size:12px;color:#cbd5e1;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .badge{border:1px solid #243041;border-radius:8px;padding:.08rem .45rem;font-size:12px;color:#cbd5e1}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .search{
      background:#0f172a;color:var(--text);border:1px solid #243041;border-radius:12px;
      padding:10px 12px;min-width:220px;outline:none
    }
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;background:var(--btn);color:var(--btnText);
      border:1px solid #273244;border-radius:12px;padding:.6rem .9rem;font-weight:700;text-decoration:none
    }
    .btn:hover{filter:brightness(1.06)}
    .btn[disabled]{opacity:.55;pointer-events:none}

    .bar{margin:12px 0 18px;border-top:1px solid var(--line)}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:var(--chip);color:#cbd5e1;border:1px solid #273244;border-radius:999px;
      padding:.35rem .7rem;font-size:13px;cursor:pointer;user-select:none
    }
    .chip.active{background:var(--chipActive);color:#fff;border-color:#3b4456}

    .section{margin:18px 0}
    .section h2{font-size:16px;margin:0 0 10px;color:#cbd5e1}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .docbtn{
      display:block;width:100%;text-align:center;background:#0f172a;color:#e5e7eb;
      border:1px solid #243041;border-radius:12px;padding:14px;font-weight:800;text-decoration:none
    }
    .docbtn:hover{filter:brightness(1.06)}
    .muted{color:var(--muted);font-size:13px;min-height:18px;margin-bottom:10px}

    .banner{
      display:none;margin:10px 0 14px;padding:10px 12px;border-radius:12px;
      border:1px solid #334155;background:#0f172a;color:#e5e7eb;
      align-items:center;justify-content:space-between;gap:10px
    }
    .banner.show{display:flex}
    .banner .actions{display:flex;gap:8px}
    .banner .actions .btn{padding:.45rem .75rem;border-radius:10px}

    .progress{display:none;margin:10px 0 0;border-radius:12px;border:1px solid #273244;padding:10px 12px}
    .progress.show{display:block}
    .p-track{height:10px;background:#0f172a;border:1px solid #243041;border-radius:999px;overflow:hidden}
    .p-bar{height:100%;width:0%;background:var(--accent);transition:width .15s linear}
    .p-text{font-size:12px;color:#cbd5e1;margin-top:8px;display:flex;justify-content:space-between}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üóÇÔ∏è TFS Documents</h1>
        <div class="subline">
          Works offline ¬∑ Manage items in <code>docs/manifest.json</code>
          <span id="versionBadge" class="badge"></span>
        </div>
      </div>
      <div class="controls">
        <input id="q" class="search" type="search" placeholder="Search‚Ä¶" />
        <button id="offlineBtn" class="btn">Download for offline</button>
      </div>
    </header>

    <!-- install banner (PWA) -->
    <div id="installBanner" class="banner">
      <div><strong>Install app?</strong> Add to Home Screen for full-screen & offline access.</div>
      <div class="actions">
        <button id="installYes" class="btn">Install</button>
        <button id="installNo"  class="btn" style="background:#111827">Not now</button>
      </div>
    </div>

    <!-- update banner -->
    <div id="updateBanner" class="banner">
      <div><strong>New documents available.</strong> Reload to update.</div>
      <div class="actions">
        <button id="reloadNow" class="btn" style="background:var(--accent2);border-color:var(--accent2)">Reload</button>
      </div>
    </div>

    <!-- progress -->
    <div id="progBox" class="progress">
      <div class="p-track"><div id="pbar" class="p-bar"></div></div>
      <div class="p-text"><span id="pmsg">Preparing‚Ä¶</span><span id="pcnt">0%</span></div>
    </div>

    <div class="bar"></div>

    <!-- Tag chips -->
    <div id="chips" class="chips"></div>

    <!-- where sections render -->
    <div id="sections"></div>
  </div>

  <script>
    /********** helpers **********/
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const verParam = v => (u) => u.includes('?') ? `${u}&v=${v}` : `${u}?v=${v}`;

    let DOCS = [];
    let TAGS = [];
    let selectedTag = localStorage.getItem('tfs.selectedTag') || 'All';
    const APP_VERSION  = window.APP_VERSION;
    const MANIFEST_URL = window.MANIFEST_URL;
    const CACHE_NAME   = window.CACHE_NAME;
    const vurl = verParam(APP_VERSION);

    /********** service worker **********/
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }

    /********** install banner **********/
    let _deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      _deferredPrompt = e;
      $('#installBanner')?.classList.add('show');
    });
    $('#installYes')?.addEventListener('click', async () => {
      if (_deferredPrompt) {
        _deferredPrompt.prompt();
        await _deferredPrompt.userChoice;
        _deferredPrompt = null;
      }
      $('#installBanner')?.classList.remove('show');
    });
    $('#installNo')?.addEventListener('click', () => $('#installBanner')?.classList.remove('show'));

    /********** update banner **********/
    $('#reloadNow')?.addEventListener('click', () => location.reload(true));
    function showUpdateBanner(){ $('#updateBanner')?.classList.add('show'); }

    /********** version badge **********/
    function setVersionBadge(manifestVersion, appVersion){
      const el = $('#versionBadge');
      if (!el) return;
      const v = (manifestVersion && String(manifestVersion).trim()) ||
                (appVersion && String(appVersion).trim()) || '';
      el.textContent = v ? `v${v}` : '';
    }

    /********** tag chips **********/
    function renderTagBar(){
      const host = $('#chips');
      host.innerHTML = '';
      const all = document.createElement('div');
      all.className = 'chip' + (selectedTag === 'All' ? ' active':'');
      all.textContent = 'All';
      all.onclick = () => { selectedTag='All'; localStorage.setItem('tfs.selectedTag', 'All'); renderTagBar(); renderSections(DOCS); };
      host.appendChild(all);

      TAGS.forEach(tag => {
        const chip = document.createElement('div');
        chip.className = 'chip' + (selectedTag === tag ? ' active':'');
        chip.textContent = tag;
        chip.onclick = () => { selectedTag=tag; localStorage.setItem('tfs.selectedTag', tag); renderTagBar(); renderSections(DOCS); };
        host.appendChild(chip);
      });
    }

    /********** sections/cards **********/
    function renderSections(sections){
      const q = ($('#q')?.value || '').trim().toLowerCase();
      const host = $('#sections');
      host.innerHTML = '';

      sections.forEach(sec => {
        // Filter items by tag + search
        const items = (sec.items || []).filter(it => {
          const matchesText = !q || it.label.toLowerCase().includes(q) || (it.desc || '').toLowerCase().includes(q);
          if (selectedTag === 'All') return matchesText;
          const secTags = sec.tags || [];
          const itTags  = it.tags || [];
          const hasTag  = secTags.includes(selectedTag) || itTags.includes(selectedTag);
          return hasTag && matchesText;
        });

        if (!items.length) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'section';
        wrapper.innerHTML = `<h2>${sec.title || ''}</h2>`;

        const grid = document.createElement('div');
        grid.className = 'grid';

        items.forEach(it => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="muted">${it.desc ? it.desc : '&nbsp;'}</div>
            <a class="docbtn" href="${vurl(it.href)}" target="_blank" rel="noopener">${it.label}</a>
          `;
          grid.appendChild(card);
        });

        wrapper.appendChild(grid);
        host.appendChild(wrapper);
      });
    }

    /********** offline download with progress **********/
    async function prefetchForOffline(sections){
      const btn  = $('#offlineBtn');
      const box  = $('#progBox');
      const bar  = $('#pbar');
      const msg  = $('#pmsg');
      const pcnt = $('#pcnt');

      const urls = new Set([
        vurl('./'), vurl('index.html'), vurl('app.webmanifest'), vurl('sw.js'),
        ...sections.flatMap(s => (s.items||[]).map(i => vurl(i.href)))
      ]);

      btn.disabled = true;
      box.classList.add('show');
      bar.style.width = '0%';
      msg.textContent = 'Starting‚Ä¶';
      pcnt.textContent = '0%';

      let done = 0, total = urls.size, failed = 0;

      try {
        const cache = await caches.open(CACHE_NAME);
        for (const u of urls) {
          try {
            msg.textContent = `Downloading ${done+1} of ${total}`;
            const res = await fetch(u, { cache: 'no-cache' });
            if (!res.ok) throw new Error(res.statusText);
            await cache.put(u, res.clone());
          } catch {
            failed++;
          } finally {
            done++;
            const p = Math.round((done/total)*100);
            bar.style.width = p + '%';
            pcnt.textContent = p + '%';
          }
        }
        msg.textContent = failed ? `Complete with ${failed} failed.` : 'All documents cached üëç';
      } catch (e) {
        msg.textContent = 'Caching failed. Try again.';
      } finally {
        setTimeout(() => { box.classList.remove('show'); }, 1200);
        btn.disabled = false;
      }
    }

    $('#offlineBtn')?.addEventListener('click', () => prefetchForOffline(DOCS));
    $('#q')?.addEventListener('input', () => renderSections(DOCS));

    /********** load manifest **********/
    async function loadDocs(){
      try{
        const r = await fetch(`${MANIFEST_URL}?v=${APP_VERSION}`, { cache:'no-cache' });
        if (!r.ok) throw new Error('manifest missing');
        const m = await r.json();

        TAGS = Array.isArray(m.tagMeta) ? m.tagMeta : [];
        DOCS = Array.isArray(m.sections) ? m.sections : [];

        if (selectedTag !== 'All' && !TAGS.includes(selectedTag)) {
          selectedTag = 'All';
          localStorage.setItem('tfs.selectedTag', 'All');
        }

        // version display & update notice
        const prev = localStorage.getItem('tfs.manifestVersion');
        setVersionBadge(m.version, APP_VERSION);
        if (m.version && prev && prev !== m.version) showUpdateBanner();
        if (m.version) localStorage.setItem('tfs.manifestVersion', m.version);
      } catch(e){
        console.warn('Manifest load failed, using fallback', e);
        TAGS = [];
        DOCS = [{ title:'MISC', items:[] }];
        setVersionBadge('', APP_VERSION);
      }

      renderTagBar();
      renderSections(DOCS);
    }

    loadDocs();
  </script>
</body>
</html>
