<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
/>
  <title>TFS Documents</title>

  <!-- PWA bits -->
  <link rel="manifest" href="app.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0f19" />

  <style>
    :root{
      --bg:#0b0f19; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --line:#1f2937; --accent:#2563eb; --accent2:#e4002b; --btn:#1f2937;
      --chip:#0f172a; --chipBd:#243041; --ring:#334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px 40px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:22px;margin:8px 0}
    .tagline{font-size:12px;color:#cbd5e1}
    .bar{margin:12px 0 16px;border-top:1px solid var(--line)}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .search{
      background:#0f172a;color:var(--text);border:1px solid var(--chipBd);
      border-radius:12px;padding:10px 12px;min-width:220px;outline:none
    }
    .btn{
      background:var(--btn);color:#f9fafb;border:1px solid #273244;border-radius:12px;
      padding:.7rem 1rem;font-weight:700;cursor:pointer
    }
    .btn:hover{filter:brightness(1.06)}
    .btn.primary{background:var(--accent2);border-color:var(--accent2)}
    .btn.ghost{background:transparent;border-color:var(--chipBd);color:#cbd5e1}

    .banner{display:none;align-items:center;justify-content:space-between;gap:10px;
      background:#0f172a;border:1px solid var(--chipBd);border-radius:12px;padding:10px 12px;margin:8px 0}
    .banner.show{display:flex}
    .banner .msg{font-size:14px;color:#e5e7eb}
    .banner .actions{display:flex;gap:8px}

    #filters{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    .chip{
      background:var(--chip);color:#e5e7eb;border:1px solid var(--chipBd);
      border-radius:999px;padding:.38rem .7rem;font-weight:600;cursor:pointer
    }
    .chip.active{background:var(--accent);border-color:var(--accent)}

    .section{margin:18px 0}
    .section h2{font-size:16px;margin:0 0 10px;color:#cbd5e1}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .muted{color:var(--muted);font-size:13px;min-height:32px;margin-bottom:10px}
    .link{
      display:block;width:100%;text-align:center;background:var(--btn);color:#f9fafb;
      border:1px solid #273244;border-radius:12px;padding:12px 14px;font-weight:700;text-decoration:none
    }
    .link:hover{filter:brightness(1.06)}

    .foot{margin-top:18px;color:#94a3b8;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üóÇÔ∏è TFS Documents</h1>
        <div class="tagline">Works offline ¬∑ Manage content via <code>docs/manifest.json</code></div>
      </div>
      <div class="controls">
        <input id="q" class="search" type="search" placeholder="Search‚Ä¶" />
        <button id="offlineBtn" class="btn">Download for offline</button>
        <button id="installBtn" class="btn ghost" style="display:none">Install app</button>
      </div>
      <div id="updateBanner" class="banner">
        <div class="msg">New or updated files are available.</div>
        <div class="actions">
          <button id="refreshBtn" class="btn primary">Update now</button>
          <button id="dismissUpdate" class="btn ghost">Dismiss</button>
        </div>
      </div>
      <div id="iosBanner" class="banner">
        <div class="msg">Add to Home Screen for offline: <b>Share</b> ‚Üí <b>Add to Home Screen</b>.</div>
        <div class="actions"><button id="dismissIOS" class="btn ghost">Got it</button></div>
      </div>
    </header>

    <div class="bar"></div>

    <!-- Filter chips -->
    <div id="filters" class="controls"></div>

    <!-- Sections render here -->
    <div id="sections"></div>

    <div class="foot">v<span id="ver"></span></div>
  </div>

  <script>
    // ====== CONFIG ======
    const APP_VERSION = "2025.09.02-1";     // bump on code changes
    const MANIFEST_URL = "docs/manifest.json";
    const CACHE_NAME = "tfs-docs-" + APP_VERSION;

    // ====== UTILS ======
    const $ = (s, r=document)=>r.querySelector(s);
    const enc = new TextEncoder();

    async function hashString(s){
      try{
        const buf = await crypto.subtle.digest("SHA-256", enc.encode(s));
        return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
      }catch{ return String(s.length); }
    }

    function inStandalone(){
      return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
             || window.navigator.standalone === true;
    }

    // ====== STATE ======
    let DOCS = [];
    let TAGS = [];
    let activeTags = new Set();
    let deferredPrompt = null;

    // ====== RENDERING ======
    function renderFilterChips(){
      const host = $("#filters"); host.innerHTML = "";
      // "All" chip
      const all = document.createElement("button");
      all.className = "chip" + (activeTags.size ? "" : " active");
      all.textContent = "All";
      all.onclick = () => { activeTags.clear(); updateHash(); draw(); };
      host.appendChild(all);
      TAGS.forEach(tag=>{
        const b = document.createElement("button");
        b.className = "chip" + (activeTags.has(tag) ? " active" : "");
        b.textContent = tag;
        b.onclick = () => {
          if(activeTags.has(tag)) activeTags.delete(tag); else activeTags.add(tag);
          updateHash(); draw();
        };
        host.appendChild(b);
      });
    }

    function matchesTags(itemTags=[], secTags=[]){
      if (!activeTags.size) return true;
      const all = new Set([...(itemTags||[]), ...(secTags||[])]);
      for (const t of activeTags) if (all.has(t)) return true;
      return false;
    }

    function draw(){
      renderFilterChips();
      renderSections(DOCS);
    }

    function renderSections(sections){
      const q = ($("#q")?.value || "").trim().toLowerCase();
      const host = $("#sections"); host.innerHTML = "";

      sections.forEach(sec=>{
        const items = (sec.items||[]).filter(it=>{
          const qHit = !q || it.label.toLowerCase().includes(q);
          const tHit = matchesTags(it.tags, sec.tags);
          return qHit && tHit;
        });
        if(!items.length) return;

        const wrapper = document.createElement("div");
        wrapper.className = "section";
        wrapper.innerHTML = `<h2>${sec.title||""}</h2>`;

        const grid = document.createElement("div");
        grid.className = "grid";

        items.forEach(it=>{
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="muted">${it.desc || "&nbsp;"}</div>
            <a class="link" href="${it.href}" target="_blank" rel="noopener">${it.label}</a>
          `;
          grid.appendChild(card);
        });

        wrapper.appendChild(grid);
        host.appendChild(wrapper);
      });
    }

    function getAllTags(sections){
      const s = new Set();
      sections.forEach(sec=>{
        (sec.tags||[]).forEach(t=>s.add(t));
        (sec.items||[]).forEach(it=>(it.tags||[]).forEach(t=>s.add(t)));
      });
      return [...s];
    }

    function updateHash(){
      const list = [...activeTags];
      if(list.length) location.hash = "tags=" + encodeURIComponent(list.join(","));
      else location.hash = "";
    }
    function readHash(){
      const m = location.hash.match(/tags=([^&]+)/);
      if(!m){ activeTags.clear(); return; }
      const arr = decodeURIComponent(m[1]).split(",").map(s=>s.trim()).filter(Boolean);
      activeTags = new Set(arr);
    }

    // ====== MANIFEST / CONTENT LOADING ======
    async function loadDocsAndDetectUpdates(){
      const r = await fetch(MANIFEST_URL, { cache: "no-cache" });
      if(!r.ok) throw new Error("manifest missing");
      const manifest = await r.json();

      DOCS = manifest.sections || [];
      TAGS = (manifest.tagMeta && manifest.tagMeta.length)
              ? manifest.tagMeta
              : getAllTags(DOCS).sort();

      // update version label
      $("#ver").textContent = APP_VERSION + (manifest.version ? (" ¬∑ m" + manifest.version) : "");

      // change detection
      const raw = JSON.stringify(manifest);
      const newHash = await hashString(raw);
      const oldHash = localStorage.getItem("tfsDocs.manifestHash") || "";
      if (oldHash && newHash !== oldHash){
        // only show if user has cached at least once (so it's meaningful)
        if (localStorage.getItem("tfsDocs.cachedOnce") === "1"){
          $("#updateBanner").classList.add("show");
        }
      }
      localStorage.setItem("tfsDocs.manifestHash", newHash);

      readHash();
      draw();
    }

    // ====== OFFLINE / SW ======
    async function prefetchOffline(){
      // register SW (best effort)
      if("serviceWorker" in navigator){
        try{ await navigator.serviceWorker.register("sw.js"); }catch{}
      }
      const urls = new Set(["./","index.html","app.webmanifest","sw.js"]);
      DOCS.forEach(sec => (sec.items||[]).forEach(it => urls.add(it.href)));

      try{
        const c = await caches.open(CACHE_NAME);
        await c.addAll([...urls]);
        localStorage.setItem("tfsDocs.cachedOnce","1");
        alert("Documents cached for offline use ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Could not cache everything. Try again once files finish uploading.");
      }
    }

    async function hardRefresh(){
      // blow old caches (only ours)
      const keys = await caches.keys();
      await Promise.all(keys.filter(k=>k.startsWith("tfs-docs-")).map(k=>caches.delete(k)));
      location.reload();
    }

    // ====== INSTALL BANNER ======
    window.addEventListener("beforeinstallprompt", (e)=>{
      // desktop & Android
      e.preventDefault();
      deferredPrompt = e;
      if(!inStandalone()) $("#installBtn").style.display = "inline-block";
    });

    $("#installBtn").addEventListener("click", async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      try{ await deferredPrompt.userChoice; }catch{}
      deferredPrompt = null;
      $("#installBtn").style.display = "none";
    });

    // iOS smart hint (once)
    (function showIOSHintOnce(){
      const ua = navigator.userAgent || "";
      const isIOS = /iPad|iPhone|iPod/.test(ua);
      if(isIOS && !inStandalone() && localStorage.getItem("tfsDocs.iosHint") !== "1"){
        $("#iosBanner").classList.add("show");
      }
      $("#dismissIOS").addEventListener("click", ()=>{
        localStorage.setItem("tfsDocs.iosHint","1");
        $("#iosBanner").classList.remove("show");
      });
    })();

    // ====== WIRE UI ======
    $("#q").addEventListener("input", draw);
    $("#offlineBtn").addEventListener("click", prefetchOffline);
    $("#refreshBtn").addEventListener("click", hardRefresh);
    $("#dismissUpdate").addEventListener("click", ()=>$("#updateBanner").classList.remove("show"));
    window.addEventListener("hashchange", ()=>{ readHash(); draw(); });

    // ====== BOOT ======
    (async function start(){
      try{ await loadDocsAndDetectUpdates(); }
      catch(e){ console.error(e); document.querySelector("#sections").innerHTML = "<p>Could not load manifest.</p>"; }
      // lightweight SW registration to enable offline later
      if("serviceWorker" in navigator){
        try{ await navigator.serviceWorker.register("sw.js"); }catch{}
      }
    })();
  </script>
</body>
</html>
