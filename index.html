<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>TFS Documents</title>
  <meta name="description" content="Offline-capable quick launcher for TFS documents and checklists." />
  <meta name="theme-color" content="#121826" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <link rel="manifest" href="app.webmanifest" />

  <style>
    :root{
      --bg:#0f1420;
      --panel:#121826;
      --text:#eaf0ff;
      --muted:#a9b1c3;

      /* Blues */
      --brand:#37b3e7;
      --chip-bg:#11233a;
      --chip-border:#334a70;
      --chip-glow:0 0 0 6px rgba(55,179,231,.12),0 0 18px rgba(55,179,231,.16);
      --chip-glow-faint:0 0 0 4px rgba(55,179,231,.08);

      /* EMER metallic palette */
      --emer-top:#ff5f6b;
      --emer-core:#b1141e;
      --emer-bottom:#2a0a0d;
      --emer-edge:#ffd6d8;
      --emer-border:#ff8086;

      /* Caution (muted yellow) */
      --caution-bg: #2f2a14;      /* deep muted amber base */
      --caution-top:#3a3216;      /* subtle top gloss */
      --caution-border:#6b5a1a;   /* bronze edge */
      --caution-text:#ffeab5;     /* readable warm text */

      --radius:14px;
    }

    html,body{
      height:100%;
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, #192133 0%, #0f1420 60%) fixed,
        linear-gradient(#0f1420,#0f1420);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app{max-width:1100px;margin:36px auto 72px;padding:0 16px;}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;
    }
    .title{font-size:22px;letter-spacing:.2px;font-weight:650}
    .subtle{color:var(--muted);font-size:13px}
    .small{font-size:12px}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar-meta{margin-top:6px;color:var(--muted)}

    /* ----- Buttons & links: 35% narrower + centered ----- */
    button.btn, a.link{
      display:inline-flex;align-items:center;justify-content:center;text-align:center;
      border-radius:12px;border:1px solid #263247;cursor:pointer;
      transition:transform .06s ease, border-color .2s ease, box-shadow .2s ease;
      font-weight:700;font-size:14px;
    }
    button.btn{background:var(--panel);color:var(--text);padding:10px 9px;}   /* was ~10px 14px */
    a.link{padding:10px 8px;text-decoration:none;}                            /* was ~10px 12px */

    button.btn:hover{transform:translateY(-1px);border-color:#2f3d57}
    button.btn:active{transform:translateY(0)}
    button.btn.danger, button.danger{background:#3a1215;border-color:#6a1e23;color:#ffecee} /* keep destructive flat */

    /* ----- Chips (filters) ----- */
    .chip-row{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 22px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:8px 8px;      /* narrower */
      border-radius:999px;border:1px solid var(--chip-border);
      background:linear-gradient(180deg,#1f3556 0%,#182b47 58%,#15243c 100%);
      color:#eaf0ff;font-size:13px;font-weight:700;letter-spacing:.2px;user-select:none;cursor:pointer;
      transition:box-shadow .2s ease,border-color .2s ease,transform .06s ease,background .2s ease;
      box-shadow:0 1px 0 rgba(255,255,255,.06) inset,0 10px 22px rgba(0,0,0,.28);
    }
    .chip:hover{border-color:#4a689d;transform:translateY(-1px)}
    .chip:active{transform:translateY(0)}
    .chip--active{border-color:#55c5f0;box-shadow:var(--chip-glow),0 1px 0 rgba(255,255,255,.08) inset}

    /* ----- EMER metallic shine (chips AND EMER doc links) ----- */
    .chip--emer,
    a.link.danger,
    a.link.link--emer{
      position:relative;overflow:hidden;color:#ffecee;border:1px solid var(--emer-border);
      background:
        linear-gradient(180deg,var(--emer-top) 0%,#e0373f 18%,var(--emer-core) 55%,#6e0f16 80%,var(--emer-bottom) 100%),
        linear-gradient(135deg,rgba(255,255,255,.16),rgba(255,255,255,0) 45%),
        radial-gradient(120% 80% at 50% 120%,rgba(0,0,0,.35),transparent 60%);
      box-shadow:
        0 0 0 6px rgba(234,49,60,.14),0 0 18px rgba(234,49,60,.20),
        inset 0 1px 0 rgba(255,255,255,.15),inset 0 -2px 4px rgba(0,0,0,.25);
      transition: box-shadow .2s ease, transform .06s ease, border-color .2s ease;
    }
    .chip--emer::after,
    a.link.danger::after,
    a.link.link--emer::after{
      content:"";position:absolute;left:0;right:0;top:0;height:1px;
      background:linear-gradient(90deg,transparent,var(--emer-edge),transparent);opacity:.85;pointer-events:none;
    }
    .chip--emer::before,
    a.link.danger::before,
    a.link.link--emer::before{
      content:"";position:absolute;left:-10%;right:-10%;top:-10%;height:60%;
      background:radial-gradient(120% 80% at 50% -10%,rgba(255,255,255,.32),rgba(255,255,255,0) 70%);
      pointer-events:none;mix-blend-mode:screen;
    }
    .chip--emer:hover,
    a.link.danger:hover,
    a.link.link--emer:hover{
      transform:translateY(-1px);border-color:#ffc2c5;
      box-shadow:0 0 0 8px rgba(255,82,92,.14),0 0 28px rgba(255,82,92,.22),
                 inset 0 1px 0 rgba(255,255,255,.2),inset 0 -3px 6px rgba(0,0,0,.3);
    }

    /* ----- Non-EMER links (doc buttons): higher-contrast blue/gray ----- */
    a.link{
      background:linear-gradient(180deg,#2c3f61 0%,#243551 55%,#1a2740 100%);
      border:1px solid #384f79;color:var(--text);
      box-shadow:0 8px 22px rgba(0,0,0,.25);
    }
    a.link:hover{transform:translateY(-1px);border-color:#4a689d;box-shadow:0 10px 22px rgba(0,0,0,.28),inset 0 1px 0 rgba(255,255,255,.06)}

    /* ----- Sections & cards ----- */
    .section{
      border:1px solid #223149;border-radius:var(--radius);
      background:rgba(18,24,38,.6);box-shadow:0 8px 26px rgba(0,0,0,.28);
      margin-bottom:16px;overflow:hidden;
    }
    .section-head{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-bottom:1px solid #1f2a42;
      background:linear-gradient(180deg,rgba(20,28,44,.6),rgba(14,20,33,.4));
    }
    .section-body{padding:8px 10px 10px}

    .doc-grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:8px}
    @media(min-width:720px){.doc-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:980px){.doc-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .doc-card{
      border:1px solid #223149;background:#121826;border-radius:12px;
      padding:10px 12px;display:grid;gap:6px;
      transition:transform .06s ease,border-color .2s ease,box-shadow .2s ease;
    }
    .doc-card:hover{transform:translateY(-1px);border-color:#2a3a58;box-shadow:0 8px 22px rgba(0,0,0,.25)}

    /* ----- Progress ----- */
    .progress-wrap{display:none;align-items:center;gap:10px;margin:10px 0 2px}
    .progress{height:8px;width:240px;border-radius:999px;background:#0e1728;border:1px solid #25324b;overflow:hidden}
    .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#46b5e1,#2eaadc);transition:width .15s ease}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid #263247;background:#121826;color:var(--muted)}

    /* ----- Update notice (muted yellow box) ----- */
    .notice{display:none;margin:10px 0 8px}
    .notice--warn{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:12px;
      background:linear-gradient(180deg,var(--caution-top),var(--caution-bg));
      color:var(--caution-text);
      border:1px solid var(--caution-border);
      box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .notice__dot{
      width:10px;height:10px;border-radius:50%;
      background:#f6cf6a;box-shadow:0 0 0 6px rgba(246,207,106,.1);
      flex:0 0 auto;
    }

    /* ----- Focus visibility (keyboard) ----- */
    button.btn:focus-visible, a.link:focus-visible, .chip:focus-visible{
      outline:2px solid #9fe0ff;outline-offset:3px;box-shadow:0 0 0 4px rgba(159,224,255,.25);
    }
  </style>
</head>

<body>
  <main class="app" aria-label="TFS Documents Application">
    <header>
      <div>
        <div class="title">TFS Documents</div>
        <div class="subtle" id="meta" aria-live="polite"></div>
      </div>
      <div>
        <div class="toolbar">
          <button class="btn" id="btnDownload" type="button" aria-label="Download or update all documents for offline use">Download Docs</button>
          <button class="btn danger" id="btnRemove" type="button" aria-label="Remove cached documents and reset">Remove Docs</button>
        </div>
        <div class="toolbar-meta small" id="lastDownloaded" aria-live="polite">Last download: —</div>
      </div>
    </header>

    <!-- Yellow caution notice when an update is available -->
    <div class="notice" id="updateNotice" role="status" aria-live="polite" aria-atomic="true">
      <span class="notice__dot" aria-hidden="true"></span>
      <span id="updateText"></span>
    </div>

    <!-- Progress -->
    <div class="progress-wrap" id="progressWrap" aria-hidden="true">
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="Download progress">
        <i id="progressBar" style="width:0%"></i>
      </div>
      <span class="badge" id="progressLabel">0%</span>
    </div>

    <!-- Tag filter chips -->
    <div class="chip-row" id="tagChips" aria-label="Document tag filters"></div>

    <!-- Sections mount -->
    <div id="sections"></div>
  </main>

  <noscript>
    <div class="app" style="color:#ffd9a8;background:#2a1d0f;border:1px solid #5a3d1a;border-radius:12px;padding:12px;margin:16px">
      JavaScript is required to render and cache the document list.
    </div>
  </noscript>

  <!-- App globals consumed by app.js -->
  <script>
    window.APP_VERSION  = window.APP_VERSION  || "2025.A";
    window.MANIFEST_URL = window.MANIFEST_URL || "docs/manifest.json";
    window.CACHE_NAME   = window.CACHE_NAME   || ("tfs-docs-" + window.APP_VERSION);
  </script>

  <!-- App logic -->
  <script src="app.js" defer></script>

  <!-- Minimal helpers for update notice + last download stamp -->
  <script>
    (function () {
      const LAST_KEY = "tfsDocs.lastDownloadAt";

      function formatTs(iso) {
        try {
          const d = typeof iso === "string" && /^\d+$/.test(iso) ? new Date(+iso) : new Date(iso);
          if (isNaN(d)) return null;
          return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        } catch { return null; }
      }

      // Render "Last download" from localStorage if present
      function renderLast() {
        const el = document.getElementById("lastDownloaded");
        const raw = localStorage.getItem(LAST_KEY);
        const pretty = raw && formatTs(raw);
        el.textContent = "Last download: " + (pretty || "—");
      }

      // Observe the progress bar width; when we hit 100%, stamp the time
      function watchProgress() {
        const bar = document.getElementById("progressBar");
        if (!bar) return;
        const mo = new MutationObserver(() => {
          const w = (bar.style && bar.style.width || "").trim();
          if (w === "100%") {
            const now = new Date().toISOString();
            localStorage.setItem(LAST_KEY, now);
            renderLast();
          }
        });
        mo.observe(bar, { attributes: true, attributeFilter: ["style"] });
      }

      // Yellow "Update Available" box: mirror #meta when it contains an update hint
      function syncUpdateNotice() {
        const meta = document.getElementById("meta");
        const box  = document.getElementById("updateNotice");
        const text = document.getElementById("updateText");
        if (!meta || !box || !text) return;

        const s = (meta.textContent || "").trim();
        const looksLikeUpdate = /update|available|recommend/i.test(s) && !/up to date|current/i.test(s);

        if (s && looksLikeUpdate) {
          text.textContent = s;
          box.classList.add("notice--warn");
          box.style.display = "flex";
        } else {
          text.textContent = "";
          box.classList.remove("notice--warn");
          box.style.display = "none";
        }
      }

      // Optional hooks your app.js can call (if you want explicit control)
      window.tfsDocs = Object.assign({}, window.tfsDocs, {
        downloadComplete: function (whenISO) {
          const iso = whenISO || new Date().toISOString();
          localStorage.setItem(LAST_KEY, iso);
          renderLast();
        },
        showUpdate: function (msg) {
          const meta = document.getElementById("meta");
          if (meta) { meta.textContent = msg; }
        }
      });

      // Boot
      document.addEventListener("DOMContentLoaded", () => {
        renderLast();
        watchProgress();
        syncUpdateNotice();

        // If app.js changes #meta, keep the notice synced
        const meta = document.getElementById("meta");
        if (meta) {
          const moMeta = new MutationObserver(syncUpdateNotice);
          moMeta.observe(meta, { childList: true, characterData: true, subtree: true });
        }

        // Also react if some code dispatches a custom event
        window.addEventListener("tfsdocs:download-complete", (e) => {
          const when = e && e.detail && e.detail.when;
          window.tfsDocs.downloadComplete(when);
        });
      });
    })();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
